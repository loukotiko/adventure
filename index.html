<!DOCTYPE html>
<html>
  <head>
    <script type="module">
      import { createApp } from "https://unpkg.com/petite-vue?module";

      const STORAGE_KEY = "adventure-main";
      const mainStorage = {
        fetch: () => JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"),
        save: (data) => localStorage.setItem(STORAGE_KEY, JSON.stringify(data)),
      };

      function Day({ template, ...props }) {
        return { ...props, $template: `#${template || "intro"}-template` };
      }

      function StepDay(props) {
        return {
          ...Day(props),
          dayStep: 0,
        };
      }

      const DEFAULT_HERO = {
        strength: 1,
        vitality: 1,
      };

      const ROUTES = ["castle", "river"];
      const ROUTES_COMPONENTS = {
        river: StepDay,
      };

      createApp({
        title: "Aventure v0.1",
        async onMount() {
          // Keep local save
          this.data = await mainStorage.fetch();
          if (!this.data) this.newAdventure();

          this.updateComponent();

          // Prepare things on mount
        },
        dayComponent: null,
        updateComponent() {
          this.dayComponent?.unmount();
          const wrapper = this.$refs.dayWrapper;
          if (!wrapper) return;
          wrapper.setAttribute("v-scope", "DynamicDay()");
          wrapper.innerHTML = "";
          const template = this.data.story[this.day - 1];
          this.dayComponent = createApp({
            DynamicDay: () =>
              (ROUTES_COMPONENTS[template] || Day)({
                template,
                ...this,
              }),
          }).mount(wrapper);
        },
        nextDay() {
          this.data.story.push(
            ROUTES[Math.round(Math.random() * (ROUTES.length - 1))]
          );
          this.updateComponent();
        },
        newAdventure() {
          this.data.story = [];
          this.data.hero = structuredClone(DEFAULT_HERO);
        },
        addStrength(amount = 1) {
          this.data.hero.strength++;
        },
        addVitality(amount = 1) {
          this.data.hero.vitality++;
        },
        get day() {
          return this.data.story.length;
        },
        data: {
          hero: structuredClone(DEFAULT_HERO),
          story: [],
        },
        save() {
          mainStorage.save(this.data);
        },
      }).mount("#game");
    </script>
  </head>
  <body>
    <template id="intro-template">
      <h2>Début de l'aventure</h2>
      <p>L'aventure commence !</p>
      <button @click="nextDay()">Démarrer l'aventure !</button>
    </template>

    <template id="castle-template">
      <h2>Jour {{day}}</h2>
      <h1>Chateau ! {{data}}</h1>
      <button @click="nextDay()">Jour suivant</button>
    </template>

    <template id="river-template">
      <h2>Jour {{day}}</h2>
      <h1>Rivière ! {{data}}</h1>
      <div v-if="dayStep === 0">
        <button @click="addVitality(1) + dayStep++">Se reposer</button>
        <button @click="addStrength(1) + dayStep++">Pêcher du poisson</button>
      </div>
      <div v-if="dayStep === 1">
        <button @click="nextDay()">Jour suivant</button>
      </div>
    </template>

    <div id="game" @vue:mounted="onMount" v-effect="save()" v-cloak>
      <h1>{{title}}</h1>
      <button @click="newAdventure()">Nouvelle aventure</button>
      <div ref="dayWrapper"></div>
    </div>
  </body>
</html>
